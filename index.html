#generateButton {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000000;
            border: 1px solid #333333;
        }
        
        #generateButton::before {
            content: "üîÆ";
            margin-right: 8px;
            font-size: 18px;
        }<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        /* –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--tg-theme-bg-color, #fff);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        .splash-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--tg-theme-button-color, #2481cc);
            border-radius: 50%;
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }
        
        :root {
            --primary-color: #000000;
            --accent-color: #333333;
            --primary-text-color: #ffffff;
            --background-color: #121212;
            --card-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --hint-color: #888888;
            --error-color: #ff5252;
            --success-color: #4caf50;
            --border-radius: 12px;
            --transition-speed: 0.3s;
            --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 6px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 12px 28px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            background-color: var(--background-color);
            transition: background-color var(--transition-speed) ease;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
            opacity: 0;
            animation: fadeInDown 0.6s ease forwards;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), #6c5ce7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        }
        
        /* ASCII-–∞—Ä—Ç —Å—Ç–∏–ª—å –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        .ascii-art {
            font-family: monospace;
            white-space: pre;
            line-height: 1.2;
            font-size: 6px;
            color: #ffffff;
            text-align: center;
            margin: 0 auto 15px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
            transform: scale(1.5);
            transform-origin: center;
            max-width: 100%;
            overflow-x: auto;
        }
        
        @media (min-width: 400px) {
            .ascii-art {
                font-size: 8px;
            }
        }
        
        @media (min-width: 768px) {
            .ascii-art {
                font-size: 10px;
            }
        }

        .header p {
            margin: 8px 0 0;
            font-size: 16px;
            color: var(--hint-color);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
            opacity: 0;
            animation: fadeInUp 0.6s ease 0.2s forwards;
        }

        .card:hover, .card:focus-within {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .input-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .textarea-wrapper {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border-radius: var(--border-radius);
            border: 2px solid #333333;
            font-size: 16px;
            background-color: #272727;
            color: var(--text-color);
            resize: vertical;
            transition: all var(--transition-speed) ease;
            box-sizing: border-box;
        }

        textarea:focus {
            outline: none;
            border-color: #555555;
            background-color: #2a2a2a;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .character-count {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: var(--hint-color);
            opacity: 0.8;
            pointer-events: none;
        }

        button {
            padding: 14px 18px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.15);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.25);
            background-color: #333333;
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-indicator {
            text-align: center;
            padding: 30px 20px;
            color: var(--hint-color);
            opacity: 0;
            animation: pulse 2s infinite;
            display: none;
        }

        .loader {
            width: 48px;
            height: 48px;
            margin: 0 auto 20px;
            border: 5px solid var(--card-bg-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        .error-container {
            border-radius: var(--border-radius);
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 16px;
            color: #e74c3c;
            margin: 16px 0;
            display: none;
            animation: shake 0.4s ease;
        }

        .image-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            opacity: 0;
            transition: opacity var(--transition-speed) ease;
        }

        .image-wrapper {
            width: 100%;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            background-color: var(--card-bg-color);
            position: relative;
        }

        .image-wrapper::before {
            content: "";
            display: block;
            padding-top: 100%; /* 1:1 Aspect Ratio */
        }

        .preview-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .preview-image:hover {
            transform: scale(1.02);
        }

        .buttons-container {
            display: flex;
            gap: 12px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }

        #downloadButton {
            flex: 1;
            background-color: #000000;
            border: 1px solid #333333;
            min-width: 140px;
        }

        #regenerateButton {
            flex: 1;
            background-color: #333333;
            color: var(--text-color);
            border: 1px solid #444444;
            min-width: 140px;
        }

        #regenerateButton:hover {
            background-color: #444444;
        }

        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            stroke-width: 0;
            stroke: currentColor;
            fill: currentColor;
            vertical-align: middle;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }

        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            10%, 30%, 50%, 70%, 90% {transform: translateX(-5px);}
            20%, 40%, 60%, 80% {transform: translateX(5px);}
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */
        .settings-container {
            margin-top: 12px;
        }
        
        .settings-dropdown {
            background-color: #2a2a2a;
            border-radius: var(--border-radius);
            padding: 2px;
            border: 1px solid #333333;
        }
        
        .settings-summary {
            cursor: pointer;
            padding: 10px 16px;
            font-weight: 500;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease;
        }
        
        .settings-summary:hover {
            background-color: #333333;
        }
        
        .settings-options {
            padding: 16px;
            background-color: #2a2a2a;
            border-radius: var(--border-radius);
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            border-top: 1px solid #333333;
        }
        
        .settings-option {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .settings-option label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .size-select, .style-select {
            padding: 10px 12px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 14px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        
        .slider:hover {
            opacity: 1;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω */
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                padding: 40px;
            }
            
            .buttons-container {
                max-width: 500px;
                margin: 0 auto;
            }
        }

        /* –ú–∏–Ω–∏-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* –¢–µ–º—ã –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .theme-pulse {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color: white;
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="splash-screen">
        <div class="splash-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>–ê—Ä—Ç-–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h1>
            <!-- ASCII-–∞—Ä—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="ascii-art">
 /$$$  /$$$$  /$$$$       /$$$  /$$$$ /$   /$ /$$$$ /$$$$   /$$$  /$$$$ /$$$  /$$$$  
|_  $_/ | $__  $|__  $__/      /$__  $| $_____/| $$ | $| $_____/| $__  $ /$__  $|__  $__//$__  $| $__  $ 
  | $   | $  \ $   | $        | $  \__/| $      | $$| $| $      | $  \ $| $  \ $   | $  | $  \ $| $  \ $ 
  | $   | $$$$/   | $        | $ /$$| $$$   | $ $ $| $$$   | $$$$/| $$$$   | $  | $  | $| $$$$/ 
  | $   | $__  $   | $        | $|_  $| $__/   | $  $$| $__/   | $__  $| $__  $   | $  | $  | $| $__  $ 
  | $   | $  \ $   | $        | $  \ $| $      | $\  $$| $      | $  \ $| $  | $   | $  | $  | $| $  \ $ 
 /$$$\| $  | $   | $        |  $$$/| $$$$| $ \  $| $$$$| $  | $| $  | $   | $  |  $$$/| $  | $ 
|______/|__/  |__/   |__/         \______/ |________/|__/  \__/|________/|__/  |__/|__/  |__/   |__/   \______/ |__/  |__/ 
            </div>
            <p>–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ —Ç–æ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å</p>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–≤–æ–¥–∞ -->
        <div class="card">
            <div class="input-container">
                <div class="textarea-wrapper">
                    <textarea id="promptInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–§–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–µ–π–∑–∞–∂ —Å –ø–∞—Ä—è—â–∏–º–∏ –≤ –Ω–µ–±–µ –æ—Å—Ç—Ä–æ–≤–∞–º–∏, –≤–æ–¥–æ–ø–∞–¥–∞–º–∏ –∏ –¥—Ä–µ–≤–Ω–∏–º –∑–∞–º–∫–æ–º'"></textarea>
                    <div class="character-count">0/500</div>
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="settings-container">
                    <details class="settings-dropdown">
                        <summary class="settings-summary">‚ñ∂Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚öôÔ∏è</summary>
                        <div class="settings-options">
                            <!-- –í—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                            <div class="settings-option">
                                <label for="imageSize">–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                                <select id="imageSize" class="size-select">
                                    <option value="512x512">512√ó512 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)</option>
                                    <option value="768x768">768√ó768 (–±–æ–ª—å—à–æ–π)</option>
                                    <option value="1024x1024">1024√ó1024 (–æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π)</option>
                                    <option value="512x768">512√ó768 (–ø–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π)</option>
                                    <option value="768x512">768√ó512 (–ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π)</option>
                                </select>
                            </div>
                            
                            <!-- –í—ã–±–æ—Ä —Å—Ç–∏–ª—è -->
                            <div class="settings-option">
                                <label for="styleSelect">–°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                                <select id="styleSelect" class="style-select">
                                    <option value="default">–û–±—ã—á–Ω—ã–π</option>
                                    <option value="anime">–ê–Ω–∏–º–µ</option>
                                    <option value="realistic">–§–æ—Ç–æ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</option>
                                    <option value="painting">–ñ–∏–≤–æ–ø–∏—Å—å</option>
                                    <option value="3d">3D –†–µ–Ω–¥–µ—Ä</option>
                                    <option value="sketch">–°–∫–µ—Ç—á</option>
                                </select>
                            </div>
                            
                            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                            <div class="settings-option">
                                <label for="guidance">–°—Ç–µ–ø–µ–Ω—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–ø—Ä–æ—Å—É:</label>
                                <input type="range" id="guidance" min="1" max="20" value="7" class="slider">
                                <span id="guidanceValue">7</span>
                            </div>
                        </div>
                    </details>
                </div>
                
                <button id="generateButton">
                    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>

        <div id="loadingIndicator" class="loading-indicator">
            <div class="loader"></div>
            <p>–°–æ–∑–¥–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ<span id="loadingDots">...</span></p>
            <p>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 20 —Å–µ–∫—É–Ω–¥</p>
        </div>

        <div id="errorContainer" class="error-container"></div>

        <div id="imageContainer" class="image-container">
            <div class="image-wrapper">
                <img id="previewImage" class="preview-image" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" loading="lazy">
            </div>
            
            <div class="buttons-container">
                <button id="downloadButton" data-tooltip="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç">
                    –°–∫–∞—á–∞—Ç—å
                </button>
                <button id="regenerateButton" data-tooltip="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é">
                    –°–æ–∑–¥–∞—Ç—å –µ—â—ë
                </button>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        window.addEventListener('load', function() {
            setTimeout(function() {
                // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω
                const splashScreen = document.getElementById('splash-screen');
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 300);
            }, 1000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É
        });

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
        const promptInput = document.getElementById('promptInput');
        const characterCount = document.querySelector('.character-count');
        const generateButton = document.getElementById('generateButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingDots = document.getElementById('loadingDots');
        const errorContainer = document.getElementById('errorContainer');
        const imageContainer = document.getElementById('imageContainer');
        const previewImage = document.getElementById('previewImage');
        const downloadButton = document.getElementById('downloadButton');
        const regenerateButton = document.getElementById('regenerateButton');

        // –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        let currentPrompt = '';
        let currentImageUrl = '';
        let currentSettings = {
            imageSize: '512x512',
            style: 'default', 
            guidance: 7
        };
        
        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤
        const MAX_CHARS = 500;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
        promptInput.addEventListener('input', function() {
            const length = this.value.length;
            characterCount.textContent = `${length}/${MAX_CHARS}`;
            
            if (length > MAX_CHARS) {
                characterCount.style.color = '#e74c3c';
                this.value = this.value.substring(0, MAX_CHARS);
                characterCount.textContent = `${MAX_CHARS}/${MAX_CHARS}`;
            } else {
                characterCount.style.color = 'var(--hint-color)';
            }
        });

        // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        function animateLoadingDots() {
            let count = 0;
            return setInterval(() => {
                count = (count + 1) % 4;
                const dots = '.'.repeat(count);
                loadingDots.textContent = dots.padEnd(3, ' ');
            }, 500);
        }

        // API –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç—å—é
        async function generateImageAPI(prompt, settings) {
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É —á–µ—Ä–µ–∑ Telegram Mini App API
                tg.sendData(JSON.stringify({
                    prompt: prompt,
                    settings: settings,
                    image_generated: false
                }));
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
                return "pending";
            } catch (error) {
                throw new Error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.");
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL
        async function checkImageExists(imageUrl, maxAttempts = 30, intervalMs = 2000) {
            let attempts = 0;
            
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(imageUrl, { method: 'HEAD' });
                    if (response.ok) {
                        return true;
                    }
                } catch (e) {
                    console.log('Error checking image:', e);
                }
                
                attempts++;
                console.log(`Checking for image... Attempt ${attempts}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, intervalMs));
            }
            
            return false;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async function generateImage() {
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç
            currentPrompt = prompt;

            // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –≤–≤–æ–¥–æ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const card = document.querySelector('.card');
            card.style.opacity = '0';
            card.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                card.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                generateButton.disabled = true;
                loadingIndicator.style.display = 'block';
                loadingIndicator.style.opacity = '1';
                loadingIndicator.classList.add('animate__animated', 'animate__fadeIn');
                errorContainer.style.display = 'none';
                imageContainer.style.display = 'none';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
                const dotsInterval = animateLoadingDots();

                // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                (async () => {
                    try {
                        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        currentSettings.imageSize = document.getElementById('imageSize').value;
                        currentSettings.style = document.getElementById('styleSelect').value;
                        currentSettings.guidance = document.getElementById('guidance').value;
                        
                        // –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        await generateImageAPI(prompt, currentSettings);
                        
                        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp API
                        const userId = tg.initDataUnsafe.user.id;
                        const imageUrl = `${window.location.origin}/api/image/${userId}`;
                        
                        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª–æ—Å—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        const imageExists = await checkImageExists(imageUrl);
                        
                        if (imageExists) {
                            // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
                            previewImage.src = `${imageUrl}?t=${new Date().getTime()}`; // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
                            
                            previewImage.onload = () => {
                                // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                                clearInterval(dotsInterval);
                                loadingIndicator.style.display = 'none';
                                
                                imageContainer.style.display = 'flex';
                                imageContainer.style.animation = 'scaleIn 0.4s ease forwards';
                                
                                // –°–∫—Ä–æ–ª–ª –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
                                setTimeout(() => {
                                    imageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }, 100);
                            };
                        } else {
                            // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫,
                            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –∏ —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                            clearInterval(dotsInterval);
                            loadingIndicator.style.display = 'none';
                            
                            // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                            const [width, height] = currentSettings.imageSize.split('x');
                            previewImage.src = `/api/placeholder/${width}/${height}`; // –ó–∞–≥–ª—É—à–∫–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
                            
                            previewImage.onload = () => {
                                imageContainer.style.display = 'flex';
                                imageContainer.style.animation = 'scaleIn 0.4s ease forwards';
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç
                                showMessage("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç Telegram");
                                
                                setTimeout(() => {
                                    imageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }, 100);
                            };
                        }
                        
                        previewImage.onload = () => {
                            // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                            clearInterval(dotsInterval);
                            loadingIndicator.style.display = 'none';
                            
                            imageContainer.style.display = 'flex';
                            imageContainer.style.animation = 'scaleIn 0.4s ease forwards';
                            
                            // –°–∫—Ä–æ–ª–ª –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
                            setTimeout(() => {
                                imageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }, 100);
                        };
                        
                        generateButton.disabled = false;
                    } catch (error) {
                        clearInterval(dotsInterval);
                        showError(error.message);
                        loadingIndicator.style.display = 'none';
                        generateButton.disabled = false;
                        
                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤–≤–æ–¥–∞ —Å–Ω–æ–≤–∞
                        card.style.display = 'block';
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 10);
                    }
                })();
            }, 300); // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–∫—Ä—ã—Ç–∏—è
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
            errorContainer.classList.add('animate__animated', 'animate__shakeX');
            setTimeout(() => {
                errorContainer.classList.remove('animate__animated', 'animate__shakeX');
            }, 1000);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        function showMessage(message) {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
            let messageElement = document.getElementById('userMessage');
            if (!messageElement) {
                messageElement = document.createElement('div');
                messageElement.id = 'userMessage';
                messageElement.style.cssText = `
                    background-color: rgba(36, 129, 204, 0.1);
                    border-left: 4px solid var(--primary-color);
                    padding: 12px 16px;
                    margin: 16px 0;
                    border-radius: var(--border-radius);
                    color: var(--text-color);
                    font-size: 14px;
                    animation: fadeIn 0.3s ease;
                `;
                imageContainer.appendChild(messageElement);
            }
            
            messageElement.textContent = message;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        generateButton.addEventListener('click', generateImage);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞
        const guidanceSlider = document.getElementById('guidance');
        const guidanceValue = document.getElementById('guidanceValue');
        guidanceSlider.addEventListener('input', function() {
            guidanceValue.textContent = this.value;
        });
        
        // –¢–∞–∫–∂–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        promptInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateImage();
            }
        });

        regenerateButton.addEventListener('click', function() {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            imageContainer.style.opacity = '0';
            
            setTimeout(() => {
                imageContainer.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –≤–≤–æ–¥–æ–º
                const card = document.querySelector('.card');
                card.style.display = 'block';
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                    
                    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    promptInput.focus();
                    
                    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞–≤–µ—Ä—Ö, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 10);
            }, 300);
        });

        downloadButton.addEventListener('click', function() {
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞–∂–∞—Ç–∏—è
            this.classList.add('animate__animated', 'animate__pulse');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram –±–æ—Ç
            tg.sendData(JSON.stringify({
                prompt: currentPrompt,
                settings: currentSettings,
                image_generated: true // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ
            }));
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp
            setTimeout(() => {
                tg.close();
            }, 300);
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ WebApp
        tg.BackButton.onClick(function() {
            // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ñ–æ—Ä–º–µ –≤–≤–æ–¥–∞
            if (imageContainer.style.display !== 'none') {
                imageContainer.style.display = 'none';
                errorContainer.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –≤–≤–æ–¥–æ–º
                const card = document.querySelector('.card');
                card.style.display = 'block';
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 10);
                
                tg.BackButton.hide();
            } else {
                // –ò–Ω–∞—á–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp
                tg.close();
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥", –∫–æ–≥–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
        const showBackButton = () => {
            if (imageContainer.style.display !== 'none') {
                tg.BackButton.show();
            } else {
                tg.BackButton.hide();
            }
        };

        // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        const observer = new MutationObserver(showBackButton);
        observer.observe(imageContainer, { attributes: true, attributeFilter: ['style'] });

        // –ò—Å—Ö–æ–¥–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
        tg.BackButton.hide();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
        promptInput.dispatchEvent(new Event('input'));
    </script>
</body>
</html>
